// ==================== DAKA KNOWLEDGE BASE ====================
/**
 * DAKA Knowledge Base - Rule-based responses
 * Add more Q&A here to increase DAKA hit rate and reduce AI costs
 */

const chatbotKnowledgeBase = {
    vi: {
        greetings: [
            "ğŸ‘‹ Xin chÃ o! TÃ´i lÃ  DAKA, trá»£ lÃ½ áº£o cá»§a Huá»³nh PhÃº XuÃ¢n.\n\nTÃ´i cÃ³ thá»ƒ giÃºp báº¡n:\nâ€¢ Hiá»ƒu vá» Kinh táº¿ HÃ nh vi\nâ€¢ TÃ¬m hiá»ƒu ná»™i dung blog\nâ€¢ Tráº£ lá»i cÃ¢u há»i vá» website\n\nHÃ£y thá»­ cÃ¡c cÃ¢u há»i nhanh bÃªn dÆ°á»›i! ğŸ˜Š",
            "ChÃ o báº¡n! ğŸ‘‹ TÃ´i lÃ  DAKA, trá»£ lÃ½ AI cá»§a XuÃ¢n.\n\nBáº¡n muá»‘n biáº¿t gÃ¬ vá»:\nğŸ¯ Kinh táº¿ HÃ nh vi\nğŸ“ Blog & BÃ i viáº¿t\nğŸ‘¤ ThÃ´ng tin cÃ¡ nhÃ¢n\n\nHá»i tÃ´i báº¥t cá»© Ä‘iá»u gÃ¬ nhÃ©!",
            "Hello! ğŸ§  TÃ´i lÃ  DAKA.\n\nTÃ´i cÃ³ thá»ƒ tráº£ lá»i cÃ¡c cÃ¢u há»i vá»:\nâœ¨ Behavioral Economics\nâœ¨ Blog posts vÃ  insights\nâœ¨ Website nÃ y\n\nBáº¡n cáº§n giÃºp gÃ¬?"
        ],
        
        intro: "ğŸŒŸ **Vá» Website nÃ y:**\n\nÄÃ¢y lÃ  portfolio cÃ¡ nhÃ¢n cá»§a **Huá»³nh PhÃº XuÃ¢n** - má»™t Behavioral Economist chuyÃªn vá» Market Research vÃ  Social Analysis.\n\nğŸ“ **Ná»™i dung:**\nâ€¢ Blog vá» Kinh táº¿ HÃ nh vi & TÃ¢m lÃ½ há»c\nâ€¢ PhÃ¢n tÃ­ch xÃ£ há»™i & Insights thá»‹ trÆ°á»ng\nâ€¢ NghiÃªn cá»©u vá» hÃ nh vi tiÃªu dÃ¹ng\n\nğŸ¯ **Má»¥c Ä‘Ã­ch:** Chia sáº» kiáº¿n thá»©c vÃ  quan Ä‘iá»ƒm vá» cÃ¡ch con ngÆ°á»i ra quyáº¿t Ä‘á»‹nh trong kinh táº¿ vÃ  Ä‘á»i sá»‘ng.",
        
        behavioral: "ğŸ§  **Kinh táº¿ HÃ nh vi (Behavioral Economics) lÃ  gÃ¬?**\n\nLÃ  lÄ©nh vá»±c nghiÃªn cá»©u cÃ¡ch con ngÆ°á»i **THá»°C Sá»°** ra quyáº¿t Ä‘á»‹nh kinh táº¿, khÃ´ng pháº£i cÃ¡ch há» **NÃŠN** ra quyáº¿t Ä‘á»‹nh (nhÆ° kinh táº¿ há»c cá»• Ä‘iá»ƒn cho ráº±ng).\n\nğŸ’¡ **VÃ­ dá»¥ thá»±c táº¿:**\nâ€¢ Táº¡i sao báº¡n mua thá»© khÃ´ng cáº§n khi sale?\nâ€¢ VÃ¬ sao giÃ¡ $9.99 háº¥p dáº«n hÆ¡n $10?\nâ€¢ Táº¡i sao ngÆ°á»i ta sá»£ máº¥t hÆ¡n ham Ä‘Æ°á»£c?\n\nğŸ“ **á»¨ng dá»¥ng:**\nMarketing, ChÃ­nh sÃ¡ch cÃ´ng, UX Design, Äáº§u tÆ° tÃ i chÃ­nh...\n\nğŸ“š KhÃ¡m phÃ¡ thÃªm trong pháº§n Blog!",
        
        latestBlogs: "ğŸ“ **Blog má»›i nháº¥t:**\n\nCÃ¡c bÃ i viáº¿t Ä‘Æ°á»£c cáº­p nháº­t thÆ°á»ng xuyÃªn vá»:\n\nğŸ¯ **Kinh táº¿ há»c:**\nHiá»‡u á»©ng Neo, Loss Aversion, Anchoring...\n\nğŸ§  **TÃ¢m lÃ½ há»c:**\nFOMO, Confirmation Bias, Decision-making...\n\nğŸŒ **XÃ£ há»™i:**\nVÄƒn hÃ³a tiÃªu dÃ¹ng, Gen Z, Social trends...\n\nğŸ“Š **Khoa há»c & CÃ´ng nghá»‡:**\nAI, Data analysis, Future trends...\n\nğŸ‘‰ Xem táº¥t cáº£ táº¡i pháº§n **Blogs** trÃªn menu!",
        
        contact: "ğŸ“¬ **LiÃªn há»‡ vá»›i XuÃ¢n:**\n\nğŸ“§ Email: [Xem pháº§n Contact]\nğŸ’¼ LinkedIn: [Xem pháº§n Contact]\nğŸ¦ Social: [Xem pháº§n Contact]\n\nğŸ’¡ Báº¡n cÅ©ng cÃ³ thá»ƒ Ä‘á»ƒ láº¡i comment trÃªn cÃ¡c bÃ i blog!\n\nâ° **Response time:** ThÆ°á»ng trong 24-48 giá».",
        
        cv: "ğŸ“„ **Há»“ sÆ¡ & Kinh nghiá»‡m:**\n\nXuÃ¢n cÃ³ background vá»:\nâ€¢ Behavioral Economics\nâ€¢ Market Research\nâ€¢ Consumer Psychology\nâ€¢ Social Analysis\n\nğŸ“ **ChuyÃªn mÃ´n:**\nâ€¢ PhÃ¢n tÃ­ch hÃ nh vi tiÃªu dÃ¹ng\nâ€¢ NghiÃªn cá»©u thá»‹ trÆ°á»ng\nâ€¢ Data-driven insights\nâ€¢ Strategic consulting\n\nğŸ‘‰ Xem chi tiáº¿t táº¡i pháº§n **Resume** trÃªn menu!",
        
        notUnderstood: [
            "ğŸ¤” Xin lá»—i, tÃ´i chÆ°a hiá»ƒu cÃ¢u há»i cá»§a báº¡n.\n\nBáº¡n cÃ³ thá»ƒ:\nâ€¢ Thá»­ cÃ¡c cÃ¢u há»i nhanh bÃªn dÆ°á»›i\nâ€¢ Há»i vá» Kinh táº¿ HÃ nh vi\nâ€¢ Há»i vá» ná»™i dung Blog\nâ€¢ Há»i vá» thÃ´ng tin liÃªn há»‡",
            "ğŸ’­ Hmm, tÃ´i chÆ°a cÃ³ cÃ¢u tráº£ lá»i cho Ä‘iá»u nÃ y.\n\nThá»­ há»i tÃ´i vá»:\nâœ¨ Behavioral Economics\nâœ¨ Blog & Articles\nâœ¨ Contact info\n\nHoáº·c dÃ¹ng cÃ¡c gá»£i Ã½ bÃªn dÆ°á»›i!",
            "ğŸ” TÃ´i Ä‘ang há»c há»i thÃªm má»—i ngÃ y!\n\nHiá»‡n táº¡i tÃ´i cÃ³ thá»ƒ giÃºp báº¡n vá»:\nğŸ“š Kinh táº¿ HÃ nh vi\nğŸ“ Ná»™i dung blog\nğŸ‘¤ ThÃ´ng tin website\n\nHÃ£y thá»­ há»i cÃ¡c chá»§ Ä‘á» nÃ y nhÃ©!"
        ],
        
        goodbye: [
            "ğŸ‘‹ Táº¡m biá»‡t! Háº¹n gáº·p láº¡i báº¡n sá»›m!\n\nğŸ’¡ Äá»«ng quÃªn ghÃ© thÄƒm pháº§n Blog Ä‘á»ƒ Ä‘á»c nhá»¯ng insights má»›i nháº¥t nhÃ©!",
            "ğŸŒŸ Bye bye! Cáº£m Æ¡n báº¡n Ä‘Ã£ ghÃ© thÄƒm!\n\nNáº¿u cÃ³ cÃ¢u há»i gÃ¬, quay láº¡i chat vá»›i tÃ´i báº¥t cá»© lÃºc nÃ o! ğŸ˜Š",
            "ğŸ‘‹ See you! Have a great day!\n\nğŸ“š Explore more articles in the Blog section!"
        ]
    },
    
    en: {
        greetings: [
            "ğŸ‘‹ Hi! I'm DAKA, Xuan's AI assistant.\n\nI can help you with:\nâ€¢ Understanding Behavioral Economics\nâ€¢ Exploring blog content\nâ€¢ Navigating this website\n\nTry the quick questions below! ğŸ˜Š",
            "Hello! ğŸ‘‹ I'm DAKA, your virtual assistant.\n\nAsk me about:\nğŸ¯ Behavioral Economics\nğŸ“ Blog posts & insights\nğŸ‘¤ About Xuan\n\nHow can I help?",
            "Hey there! ğŸ§  I'm DAKA.\n\nI can answer questions about:\nâœ¨ Behavioral Economics\nâœ¨ Blog articles\nâœ¨ This website\n\nWhat would you like to know?"
        ],
        
        intro: "ğŸŒŸ **About This Website:**\n\nThis is the personal portfolio of **Huynh Phu Xuan** - a Behavioral Economist specializing in Market Research and Social Analysis.\n\nğŸ“ **Content:**\nâ€¢ Blog about Behavioral Economics & Psychology\nâ€¢ Social analysis & Market insights\nâ€¢ Consumer behavior research\n\nğŸ¯ **Purpose:** Sharing knowledge and perspectives on how people make decisions in economics and life.",
        
        behavioral: "ğŸ§  **What is Behavioral Economics?**\n\nIt studies how people **ACTUALLY** make economic decisions, not how they **SHOULD** make them (as classical economics assumes).\n\nğŸ’¡ **Real-world examples:**\nâ€¢ Why do you buy unnecessary things on sale?\nâ€¢ Why is $9.99 more attractive than $10?\nâ€¢ Why do people fear losses more than desire gains?\n\nğŸ“ **Applications:**\nMarketing, Public Policy, UX Design, Investment...\n\nğŸ“š Explore more in the Blog section!",
        
        latestBlogs: "ğŸ“ **Latest Blogs:**\n\nRegularly updated articles about:\n\nğŸ¯ **Economics:**\nAnchoring Effect, Loss Aversion, Pricing...\n\nğŸ§  **Psychology:**\nFOMO, Cognitive Biases, Decision-making...\n\nğŸŒ **Society:**\nConsumer culture, Gen Z, Social trends...\n\nğŸ“Š **Science & Tech:**\nAI, Data analysis, Future trends...\n\nğŸ‘‰ See all in the **Blogs** menu section!",
        
        contact: "ğŸ“¬ **Contact Xuan:**\n\nğŸ“§ Email: [See Contact section]\nğŸ’¼ LinkedIn: [See Contact section]\nğŸ¦ Social: [See Contact section]\n\nğŸ’¡ You can also comment on blog posts!\n\nâ° **Response time:** Usually within 24-48 hours.",
        
        cv: "ğŸ“„ **Profile & Experience:**\n\nXuan's background includes:\nâ€¢ Behavioral Economics\nâ€¢ Market Research\nâ€¢ Consumer Psychology\nâ€¢ Social Analysis\n\nğŸ“ **Expertise:**\nâ€¢ Consumer behavior analysis\nâ€¢ Market research\nâ€¢ Data-driven insights\nâ€¢ Strategic consulting\n\nğŸ‘‰ See details in the **Resume** menu section!",
        
        notUnderstood: [
            "ğŸ¤” Sorry, I don't understand that question yet.\n\nYou can:\nâ€¢ Try quick questions below\nâ€¢ Ask about Behavioral Economics\nâ€¢ Ask about Blog content\nâ€¢ Ask about contact info",
            "ğŸ’­ Hmm, I don't have an answer for that yet.\n\nTry asking about:\nâœ¨ Behavioral Economics\nâœ¨ Blog & Articles\nâœ¨ Contact information\n\nOr use the suggestions below!",
            "ğŸ” I'm learning more every day!\n\nCurrently I can help with:\nğŸ“š Behavioral Economics\nğŸ“ Blog content\nğŸ‘¤ Website info\n\nTry asking about these topics!"
        ],
        
        goodbye: [
            "ğŸ‘‹ Goodbye! See you soon!\n\nğŸ’¡ Don't forget to check the Blog for latest insights!",
            "ğŸŒŸ Bye! Thanks for visiting!\n\nCome back and chat anytime! ğŸ˜Š",
            "ğŸ‘‹ See you! Have a great day!\n\nğŸ“š Explore more in the Blog section!"
        ]
    }
};

// Keyword patterns for matching (case-insensitive)
const keywordResponses = {
    vi: {
        'xin chÃ o|chÃ o|hello|hi|hey': 'greetings',
        'giá»›i thiá»‡u|about|website|trang web': 'intro',
        'kinh táº¿ hÃ nh vi|behavioral econ|be lÃ  gÃ¬|be|hÃ nh vi': 'behavioral',
        'blog|bÃ i viáº¿t|article|post|má»›i nháº¥t|latest': 'latestBlogs',
        'liÃªn há»‡|contact|email': 'contact',
        'cv|resume|há»“ sÆ¡|kinh nghiá»‡m|experience': 'cv',
        'táº¡m biá»‡t|bye|goodbye|see you': 'goodbye'
    },
    en: {
        'hello|hi|hey|greetings': 'greetings',
        'about|intro|website|what is this': 'intro',
        'behavioral econ|be|what is be': 'behavioral',
        'blog|article|post|latest|recent': 'latestBlogs',
        'contact|email|reach': 'contact',
        'cv|resume|profile|experience': 'cv',
        'bye|goodbye|see you|later': 'goodbye'
    }
};

// ==================== REST OF CHATBOT CODE ====================
// (The AIProvider class and DakaBot class code from previous file)

    }
    
    async isAvailable() {
        if (!this.enabled) return false;
        if (!this.apiKey) return false;
        
        // Check if we still have tokens
        const hasTokens = this.tokensUsed < this.tokenLimit;
        
        if (!hasTokens) {
            console.warn(`${this.name}: Token limit reached (${this.tokensUsed}/${this.tokenLimit})`);
        }
        
        return hasTokens;
    }
    
    async ask(question, context = []) {
        try {
            const messages = this.buildMessages(question, context);
            
            const response = await fetch(this.endpoint, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${this.apiKey}`
                },
                body: JSON.stringify({
                    model: this.model,
                    messages: messages,
                    temperature: this.temperature,
                    max_tokens: this.maxTokens,
                    stream: false
                })
            });
            
            if (!response.ok) {
                const error = await response.text();
                throw new Error(`API Error ${response.status}: ${error}`);
            }
            
            const data = await response.json();
            const answer = data.choices[0].message.content;
            
            // Track usage
            const inputTokens = data.usage?.prompt_tokens || 0;
            const outputTokens = data.usage?.completion_tokens || 0;
            const totalTokens = inputTokens + outputTokens;
            
            this.tokensUsed += totalTokens;
            this.saveTokensUsed();
            
            // Calculate cost
            const cost = (inputTokens / 1_000_000 * 0.14) + (outputTokens / 1_000_000 * 0.28);
            this.trackSuccess(cost);
            
            console.log(`ğŸ’° ${this.name} cost: $${cost.toFixed(6)} | Total: $${this.stats.totalCost.toFixed(4)}`);
            
            return answer;
            
        } catch (error) {
            return this.handleError(error);
        }
    }
    
    buildMessages(question, context) {
        const systemPrompt = this.config.systemPrompt || this.getDefaultSystemPrompt();
        
        const messages = [
            { role: 'system', content: systemPrompt }
        ];
        
        // Add conversation context (last 3 exchanges max)
        const recentContext = context.slice(-6);
        messages.push(...recentContext);
        
        // Add current question
        messages.push({ role: 'user', content: question });
        
        return messages;
    }
    
    getDefaultSystemPrompt() {
        return `You are DAKA, an AI assistant for Huynh Phu Xuan's portfolio website.

ABOUT THE OWNER:
- Name: Huynh Phu Xuan (Huá»³nh PhÃº XuÃ¢n)
- Role: Behavioral Economist
- Expertise: Behavioral Economics, Market Research, Consumer Psychology, Social Analysis

YOUR ROLE:
- Help visitors understand website content
- Answer questions about Behavioral Economics
- Provide insights on market research and consumer behavior
- Be professional yet approachable

RESPONSE GUIDELINES:
- Keep answers concise (2-4 paragraphs max)
- Use simple language, avoid jargon when possible
- Add 1-2 relevant emojis for warmth
- Reference portfolio content when relevant
- Suggest visiting relevant sections when appropriate

TONE: Professional, friendly, knowledgeable, helpful
LANGUAGE: Match user's language (Vietnamese or English)`;
    }
    
    loadTokensUsed() {
        const saved = localStorage.getItem('deepseek_tokens_used');
        return saved ? parseInt(saved) : 0;
    }
    
    saveTokensUsed() {
        localStorage.setItem('deepseek_tokens_used', this.tokensUsed.toString());
    }
    
    estimateCost(question, response) {
        // Rough estimate: ~1 token per 4 characters
        const inputTokens = question.length / 4;
        const outputTokens = response.length / 4;
        return (inputTokens / 1_000_000 * 0.14) + (outputTokens / 1_000_000 * 0.28);
    }
}

// ==================== EXAMPLE: CHATBASE PROVIDER (READY TO USE) ====================
/**
 * Chatbase AI Provider - Example implementation
 * Uncomment and add API key to enable
 */
class ChatbaseProvider extends AIProvider {
    constructor(apiKey, config = {}) {
        super('Chatbase', config);
        this.apiKey = apiKey;
        this.chatbotId = config.chatbotId;
        this.endpoint = `https://www.chatbase.co/api/v1/chat`;
    }
    
    async isAvailable() {
        return this.enabled && !!this.apiKey;
    }
    
    async ask(question, context = []) {
        try {
            const response = await fetch(this.endpoint, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${this.apiKey}`
                },
                body: JSON.stringify({
                    messages: [{ content: question }],
                    chatbotId: this.chatbotId,
                    stream: false
                })
            });
            
            if (!response.ok) throw new Error(`API Error: ${response.status}`);
            
            const data = await response.json();
            this.trackSuccess();
            
            return data.text;
            
        } catch (error) {
            return this.handleError(error);
        }
    }
}

// ==================== EXAMPLE: HUGGING FACE PROVIDER (READY TO USE) ====================
/**
 * Hugging Face Inference API Provider
 * Free tier: 30,000 requests/month
 */
class HuggingFaceProvider extends AIProvider {
    constructor(apiKey, config = {}) {
        super('HuggingFace', config);
        this.apiKey = apiKey;
        this.model = config.model || 'mistralai/Mixtral-8x7B-Instruct-v0.1';
        this.endpoint = `https://api-inference.huggingface.co/models/${this.model}`;
    }
    
    async isAvailable() {
        return this.enabled && !!this.apiKey;
    }
    
    async ask(question, context = []) {
        try {
            const prompt = this.buildPrompt(question, context);
            
            const response = await fetch(this.endpoint, {
                method: 'POST',
                headers: {
                    'Authorization': `Bearer ${this.apiKey}`,
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    inputs: prompt,
                    parameters: {
                        max_new_tokens: 500,
                        temperature: 0.7
                    }
                })
            });
            
            if (!response.ok) throw new Error(`API Error: ${response.status}`);
            
            const data = await response.json();
            const answer = data[0]?.generated_text || data.error;
            
            this.trackSuccess();
            return answer;
            
        } catch (error) {
            return this.handleError(error);
        }
    }
    
    buildPrompt(question, context) {
        return `You are DAKA, a helpful AI assistant. Answer this question concisely:

Question: ${question}

Answer:`;
    }
}

// ==================== DAKA CHATBOT - MAIN CLASS ====================
/**
 * DAKA Chatbot with modular AI providers
 * Easy to add new providers - just extend AIProvider!
 */
class DakaBot {
    constructor() {
        this.currentLang = localStorage.getItem('preferred-language') || 'vi';
        this.isOpen = false;
        this.messageHistory = [];
        this.conversationContext = [];
        
        // AI Providers (priority order)
        this.aiProviders = [];
        
        // Stats
        this.stats = {
            totalQueries: 0,
            dakaHits: 0,
            aiHits: 0,
            aiHitsByProvider: {}
        };
        
        this.init();
    }
    
    init() {
        this.cacheDOMElements();
        this.attachEventListeners();
        this.displayGreeting();
        this.loadStats();
    }
    
    // ==================== AI PROVIDER MANAGEMENT ====================
    
    /**
     * Register an AI provider
     * @param {AIProvider} provider - AI provider instance
     * @param {number} priority - Lower number = higher priority (0 = highest)
     */
    registerProvider(provider, priority = 99) {
        this.aiProviders.push({ provider, priority });
        
        // Sort by priority (ascending)
        this.aiProviders.sort((a, b) => a.priority - b.priority);
        
        console.log(`âœ… Registered ${provider.name} (Priority: ${priority})`);
        
        // Initialize stats tracking
        if (!this.stats.aiHitsByProvider[provider.name]) {
            this.stats.aiHitsByProvider[provider.name] = 0;
        }
    }
    
    /**
     * Remove an AI provider
     */
    removeProvider(providerName) {
        this.aiProviders = this.aiProviders.filter(
            p => p.provider.name !== providerName
        );
        console.log(`âŒ Removed ${providerName}`);
    }
    
    /**
     * Enable/disable a provider
     */
    toggleProvider(providerName, enabled) {
        const item = this.aiProviders.find(p => p.provider.name === providerName);
        if (item) {
            item.provider.enabled = enabled;
            console.log(`${enabled ? 'âœ…' : 'â¸ï¸'} ${providerName} ${enabled ? 'enabled' : 'disabled'}`);
        }
    }
    
    /**
     * Get list of all providers
     */
    getProviders() {
        return this.aiProviders.map(p => ({
            name: p.provider.name,
            priority: p.priority,
            enabled: p.provider.enabled,
            stats: p.provider.getStats()
        }));
    }
    
    // ==================== MESSAGE PROCESSING ====================
    
    async processMessage(message) {
        this.stats.totalQueries++;
        
        // STEP 1: Try DAKA (Rule-based Knowledge Base)
        const dakaResponse = this.checkDakaKB(message.toLowerCase());
        
        if (dakaResponse) {
            this.stats.dakaHits++;
            console.log('ğŸ’š DAKA hit (rule-based, free, instant)');
            
            return {
                text: dakaResponse,
                source: 'DAKA',
                fromAI: false,
                cost: 0
            };
        }
        
        // STEP 2: Try AI providers in priority order
        for (const { provider } of this.aiProviders) {
            const available = await provider.isAvailable();
            
            if (!available) {
                console.log(`â­ï¸ Skipping ${provider.name} (not available)`);
                continue;
            }
            
            console.log(`ğŸ¤– Trying ${provider.name}...`);
            
            const aiResponse = await provider.ask(
                message,
                this.getConversationContext()
            );
            
            if (aiResponse) {
                this.stats.aiHits++;
                this.stats.aiHitsByProvider[provider.name]++;
                
                console.log(`âœ… ${provider.name} response received`);
                
                return {
                    text: aiResponse,
                    source: provider.name,
                    fromAI: true,
                    cost: provider.stats.totalCost
                };
            }
        }
        
        // STEP 3: All failed - graceful degradation
        console.log('âš ï¸ All AI providers failed, using fallback');
        
        return {
            text: this.getFallbackResponse(),
            source: 'DAKA',
            fromAI: false,
            cost: 0
        };
    }
    
    checkDakaKB(lowerMessage) {
        const kb = chatbotKnowledgeBase[this.currentLang];
        const keywords = keywordResponses[this.currentLang];
        
        // Check for blog search
        if (this.isBlogSearchQuery(lowerMessage)) {
            return this.searchBlogs(lowerMessage);
        }
        
        // Check keyword patterns
        for (const [pattern, responseKey] of Object.entries(keywords)) {
            const regex = new RegExp(pattern, 'i');
            if (regex.test(lowerMessage)) {
                if (responseKey === 'goodbye') {
                    const goodbyes = kb.goodbye;
                    return goodbyes[Math.floor(Math.random() * goodbyes.length)];
                }
                return kb[responseKey];
            }
        }
        
        // Check conversation context
        if (this.hasRecentContext('blog')) {
            return kb.latestBlogs;
        }
        
        return null; // Not found in DAKA KB
    }
    
    getFallbackResponse() {
        const responses = chatbotKnowledgeBase[this.currentLang].notUnderstood;
        return responses[Math.floor(Math.random() * responses.length)];
    }
    
    getConversationContext() {
        // Get last 3 exchanges (6 messages) for context
        return this.messageHistory
            .slice(-6)
            .map(msg => ({
                role: msg.sender === 'user' ? 'user' : 'assistant',
                content: msg.text.replace(/<br>/g, '\n')
            }));
    }
    
    // ==================== UI METHODS (Same as before) ====================
    
    cacheDOMElements() {
        this.button = document.getElementById('chatbot-button');
        this.window = document.getElementById('chatbot-window');
        this.closeBtn = document.getElementById('chatbot-close');
        this.messagesContainer = document.getElementById('chatbot-messages');
        this.input = document.getElementById('chatbot-input');
        this.sendBtn = document.getElementById('chatbot-send');
        this.quickBtns = document.querySelectorAll('.quick-question-btn');
    }
    
    attachEventListeners() {
        this.button.addEventListener('click', () => this.toggleWindow());
        this.closeBtn.addEventListener('click', () => this.toggleWindow());
        this.sendBtn.addEventListener('click', () => this.sendMessage());
        
        this.input.addEventListener('keypress', (e) => {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                this.sendMessage();
            }
        });
        
        this.quickBtns.forEach(btn => {
            btn.addEventListener('click', (e) => {
                const question = e.target.getAttribute('data-question');
                this.handleQuickQuestion(question);
            });
        });
    }
    
    toggleWindow() {
        this.isOpen = !this.isOpen;
        this.window.classList.toggle('hidden');
        if (this.isOpen) {
            this.input.focus();
        }
    }
    
    displayGreeting() {
        const greetings = chatbotKnowledgeBase[this.currentLang].greetings;
        const greeting = greetings[Math.floor(Math.random() * greetings.length)];
        this.addMessage(greeting, 'bot', { source: 'DAKA' });
    }
    
    addMessage(text, sender, metadata = {}) {
        const messageDiv = document.createElement('div');
        messageDiv.className = `chat-message ${sender}`;
        
        const time = new Date().toLocaleTimeString(this.currentLang === 'vi' ? 'vi-VN' : 'en-US', { 
            hour: '2-digit', 
            minute: '2-digit' 
        });
        
        const formattedText = text.replace(/\n/g, '<br>');
        
        // Add source badge
        let badge = '';
        if (metadata.source && metadata.source !== 'DAKA') {
            const color = metadata.source === 'DeepSeek' ? '#667eea' : '#27ae60';
            badge = `<span class="source-badge" style="background: ${color}">ğŸ¤– ${metadata.source}</span>`;
        }
        
        if (sender === 'bot') {
            messageDiv.innerHTML = `
                <div class="message-avatar">ğŸ§ </div>
                <div>
                    <div class="message-content">${formattedText}${badge}</div>
                    <div class="message-time">${time}</div>
                </div>
            `;
        } else {
            messageDiv.innerHTML = `
                <div>
                    <div class="message-content">${formattedText}</div>
                    <div class="message-time">${time}</div>
                </div>
            `;
        }
        
        this.messagesContainer.appendChild(messageDiv);
        this.scrollToBottom();
        
        this.messageHistory.push({ text, sender, time, ...metadata });
    }
    
    async sendMessage() {
        const message = this.input.value.trim();
        if (!message) return;
        
        this.addMessage(message, 'user');
        this.input.value = '';
        this.sendBtn.disabled = true;
        
        this.conversationContext.push(message);
        
        this.showTypingIndicator();
        
        try {
            const response = await this.processMessage(message);
            
            setTimeout(() => {
                this.hideTypingIndicator();
                this.addMessage(response.text, 'bot', { 
                    source: response.source,
                    fromAI: response.fromAI 
                });
                this.sendBtn.disabled = false;
                this.saveStats();
            }, response.fromAI ? 500 : 300);
            
        } catch (error) {
            console.error('Error:', error);
            this.hideTypingIndicator();
            const errorMsg = this.currentLang === 'vi' 
                ? "Xin lá»—i, cÃ³ lá»—i xáº£y ra. Vui lÃ²ng thá»­ láº¡i!"
                : "Sorry, an error occurred. Please try again!";
            this.addMessage(errorMsg, 'bot', { source: 'DAKA' });
            this.sendBtn.disabled = false;
        }
    }
    
    handleQuickQuestion(question) {
        const kb = chatbotKnowledgeBase[this.currentLang];
        const questionTexts = {
            'intro': this.currentLang === 'vi' ? 'Giá»›i thiá»‡u website' : 'About website',
            'behavioral': this.currentLang === 'vi' ? 'Kinh táº¿ hÃ nh vi lÃ  gÃ¬?' : 'What is Behavioral Economics?',
            'blog': this.currentLang === 'vi' ? 'Xem blog má»›i nháº¥t' : 'Latest blogs'
        };
        
        this.addMessage(questionTexts[question], 'user');
        
        setTimeout(() => {
            const responses = {
                'intro': kb.intro,
                'behavioral': kb.behavioral,
                'blog': kb.latestBlogs
            };
            this.addMessage(responses[question], 'bot', { source: 'DAKA' });
        }, 500);
    }
    
    showTypingIndicator() {
        const indicator = document.createElement('div');
        indicator.className = 'chat-message bot';
        indicator.id = 'typing-indicator';
        indicator.innerHTML = `
            <div class="message-avatar">ğŸ§ </div>
            <div class="message-content">
                <div class="typing-indicator">
                    <div class="typing-dot"></div>
                    <div class="typing-dot"></div>
                    <div class="typing-dot"></div>
                </div>
            </div>
        `;
        this.messagesContainer.appendChild(indicator);
        this.scrollToBottom();
    }
    
    hideTypingIndicator() {
        const indicator = document.getElementById('typing-indicator');
        if (indicator) indicator.remove();
    }
    
    scrollToBottom() {
        this.messagesContainer.scrollTop = this.messagesContainer.scrollHeight;
    }
    
    updateLanguage(lang) {
        this.currentLang = lang;
        const placeholder = this.currentLang === 'vi' ? 'Nháº­p cÃ¢u há»i...' : 'Type your question...';
        this.input.placeholder = placeholder;
    }
    
    // ==================== HELPER METHODS ====================
    
    isBlogSearchQuery(message) {
        const searchTerms = ['tÃ¬m', 'search', 'bÃ i', 'post', 'article'];
        return searchTerms.some(term => message.includes(term));
    }
    
    searchBlogs(query) {
        // Simple blog search implementation
        const kb = chatbotKnowledgeBase[this.currentLang];
        return kb.latestBlogs; // Simplified
    }
    
    hasRecentContext(keyword) {
        return this.conversationContext.slice(-3).some(msg => 
            msg.toLowerCase().includes(keyword)
        );
    }
    
    // ==================== STATS MANAGEMENT ====================
    
    saveStats() {
        localStorage.setItem('daka_stats', JSON.stringify(this.stats));
    }
    
    loadStats() {
        const saved = localStorage.getItem('daka_stats');
        if (saved) {
            this.stats = { ...this.stats, ...JSON.parse(saved) };
        }
    }
    
    getStats() {
        const dakaHitRate = this.stats.totalQueries > 0 
            ? (this.stats.dakaHits / this.stats.totalQueries * 100).toFixed(1)
            : 0;
        
        const totalCost = this.aiProviders.reduce(
            (sum, p) => sum + p.provider.stats.totalCost, 
            0
        );
        
        return {
            totalQueries: this.stats.totalQueries,
            dakaHits: this.stats.dakaHits,
            aiHits: this.stats.aiHits,
            dakaHitRate: `${dakaHitRate}%`,
            aiHitsByProvider: this.stats.aiHitsByProvider,
            totalCost: `$${totalCost.toFixed(4)}`,
            providers: this.getProviders()
        };
    }
    
    resetStats() {
        this.stats = {
            totalQueries: 0,
            dakaHits: 0,
            aiHits: 0,
            aiHitsByProvider: {}
        };
        this.saveStats();
        
        // Reset provider stats
        this.aiProviders.forEach(p => {
            p.provider.stats = {
                totalCalls: 0,
                successCalls: 0,
                failedCalls: 0,
                totalCost: 0
            };
        });
    }
}

// ==================== ADDITIONAL CSS ====================
const additionalStyles = `
.source-badge {
    display: inline-block;
    margin-left: 0.5rem;
    padding: 0.15rem 0.5rem;
    color: white;
    border-radius: 8px;
    font-size: 0.7rem;
    font-weight: 600;
    vertical-align: middle;
}
`;

const styleSheet = document.createElement('style');
styleSheet.textContent = additionalStyles;
document.head.appendChild(styleSheet);

// ==================== INITIALIZATION ====================
/**
 * Initialize DAKA Chatbot
 * Add your AI providers here!
 */
document.addEventListener('DOMContentLoaded', () => {
    // Create chatbot instance
    window.daka = new DakaBot();
    
    // ========== METHOD 1: WITH API KEY (RECOMMENDED) ==========
    // Uncomment and add your DeepSeek API key:
    
    // const deepseek = new DeepSeekProvider('YOUR_DEEPSEEK_API_KEY_HERE', {
    //     systemPrompt: 'Custom system prompt...' // Optional
    // });
    // window.daka.registerProvider(deepseek, 1); // Priority 1 (highest)
    
    
    // ========== METHOD 2: WITHOUT API KEY (DAKA ONLY) ==========
    // Leave as-is for rule-based only
    
    
    // ========== METHOD 3: ADD LATER ==========
    // Set API key after initialization:
    // window.daka.setDeepSeekKey('sk-xxx');
    
    
    console.log('ğŸ§  DAKA Chatbot initialized');
    console.log('ğŸ“Š Registered providers:', window.daka.getProviders().length);
});

// ==================== HELPER FUNCTIONS ====================

/**
 * Easy way to add DeepSeek after initialization
 */
window.setDeepSeekKey = function(apiKey, config = {}) {
    const deepseek = new DeepSeekProvider(apiKey, config);
    window.daka.registerProvider(deepseek, 1);
    console.log('âœ… DeepSeek registered successfully');
};

/**
 * Display chatbot statistics
 */
window.showDakaStats = function() {
    const stats = window.daka.getStats();
    console.table(stats);
    console.log('\nğŸ“Š Provider Details:');
    stats.providers.forEach(p => {
        console.log(`\n${p.name}:`);
        console.table(p.stats);
    });
};

/**
 * Example: Add Chatbase provider
 */
window.addChatbase = function(apiKey, chatbotId) {
    const chatbase = new ChatbaseProvider(apiKey, { chatbotId });
    window.daka.registerProvider(chatbase, 2); // Priority 2 (after DeepSeek)
    console.log('âœ… Chatbase registered');
};

/**
 * Example: Add Hugging Face provider
 */
window.addHuggingFace = function(apiKey, model) {
    const hf = new HuggingFaceProvider(apiKey, { model });
    window.daka.registerProvider(hf, 3); // Priority 3
    console.log('âœ… Hugging Face registered');
};

// ==================== CONSOLE COMMANDS ====================
console.log(`
ğŸ§  DAKA Chatbot Commands:
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

ğŸ“¦ Setup:
  setDeepSeekKey('sk-xxx')          - Add DeepSeek API key
  addChatbase('key', 'chatbotId')   - Add Chatbase provider
  addHuggingFace('key', 'model')    - Add HuggingFace provider

ğŸ“Š Statistics:
  showDakaStats()                   - View detailed statistics
  daka.getStats()                   - Get stats object
  daka.resetStats()                 - Reset all statistics

ğŸ”§ Provider Management:
  daka.getProviders()               - List all providers
  daka.toggleProvider('Name', true) - Enable/disable provider
  daka.removeProvider('Name')       - Remove provider

ğŸ’¬ Chatbot:
  daka.isOpen                       - Check if chatbot open
  daka.messageHistory               - View message history
  daka.currentLang                  - Current language (vi/en)

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
`);
